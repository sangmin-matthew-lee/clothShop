{% extends 'shopping/basic.html' %} Checkout - ClothShop Cart {% block body %}
<div class="container">
  <div class="col my-4">
    <h2>Step 1 - Shopping Cart Checkout - Your Cart Items</h2>
    <div class="my-4">
        <ul class="list-group" id="items">
        </ul>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mt-3">
                <li class="breadcrumb-item active" aria-current="page">Your Cart Total Is <b>Rs.<span id="totalPrice"></b>  </span>Enter your details below & place your order. Thanks for shopping with ClothShop!</li>
            </ol>
        </nav>
        <span id="totalPrice"></span>
    </div>
  </div>
  <div class="col my-4">
    <h2>Step 2 - Enter Address & Other Details:</h2>
    <form method="post" action="/shopping/checkout/">
      {% csrf_token %}
      <input type="hidden" name="itemsJson" id="itemsJson" />
      <input type="hidden" name="amount" id="amount" />
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="inputname">Name</label>
          <input
            type="text"
            class="form-control"
            id="name"
            name="name"
            placeholder="Name"
          />
        </div>
        <div class="form-group col-md-6">
          <label for="inputEmail4">Email</label>
          <input
            type="email"
            class="form-control"
            id="email"
            name="email"
            placeholder="Email"
          />
        </div>
      </div>
      <div class="form-group">
        <label for="inputAddress">Address</label>
        <input
          type="text"
          class="form-control"
          id="address1"
          name="address1"
          placeholder="Enter Address"
        />
      </div>
      <div class="form-group">
        <label for="inputAddress2">Address line 2</label>
        <input
          type="text"
          class="form-control"
          id="address2"
          name="address2"
          placeholder=""
        />
      </div>
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="inputCity">City</label>
          <input
            type="text"
            class="form-control"
            id="city"
            name="city"
            placeholder="Enter City"
          />
        </div>
        <div class="form-group col-md-4">
          <label for="inputState">State</label>
          <input
            type="text"
            class="form-control"
            id="state"
            name="state"
            placeholder="Enter State"
          />
        </div>
        <div class="form-group col-md-2">
          <label for="inputZip">Pincode</label>
          <input
            type="text"
            class="form-control"
            id="pin_code"
            name="pin_code"
            placeholder="Enter pincode"
          />
        </div>
      </div>
      <div class="form-group">
        <label for="inputZip">Phone Number</label>
        <input type="tel" class="form-control" id="phone" name="phone" />
      </div>
      <button type="submit" class="btn btn-primary">Place Order</button>
    </form>
  </div>
</div>
{% endblock %} {%block js%}
<script>
    let cart = {};
    try {
      cart = JSON.parse(localStorage.getItem("cart")) || {};
    } catch (e) {
      cart = {};
    }

    function renderCart() {
      $("#items").empty();
      let sum = 0;
      let totalPrice = 0;

      if ($.isEmptyObject(cart)) {
        $("#items").append(
          "<p>Your cart is empty, please add some items before checking out ! </p>"
        );
      } else {
        for (const item in cart) {
          const name = cart[item][1];
          const qty = cart[item][0];
          const itemPrice = cart[item][2];
          sum += qty;
          totalPrice += qty * itemPrice;
          const li = `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div>${name}</div>
                <small class="text-muted">Rs.${itemPrice} each</small>
              </div>
              <div class="d-flex align-items-center">
                <div class="btn-group btn-group-sm mr-2" role="group">
                  <button class="btn btn-outline-secondary qty-minus" data-id="${item}">-</button>
                  <span class="btn btn-light disabled">${qty}</span>
                  <button class="btn btn-outline-secondary qty-plus" data-id="${item}">+</button>
                </div>
                <button class="btn btn-sm btn-outline-danger remove-item" data-id="${item}">x</button>
              </div>
            </li>`;
          $("#items").append(li);
        }
      }

      document.getElementById("cart").innerHTML = sum;
      document.getElementById("totalPrice").innerHTML = totalPrice;
      $("#itemsJson").val(JSON.stringify(cart));
      $("#amount").val(totalPrice);
    }

    // Handle remove button clicks
    $("#items").on("click", ".remove-item", function () {
      const pid = $(this).data("id");
      delete cart[pid];
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    });

    // Quantity adjusters
    $("#items").on("click", ".qty-minus", function () {
      const pid = $(this).data("id");
      if (!cart[pid]) return;
      cart[pid][0] = Math.max(0, cart[pid][0] - 1);
      if (cart[pid][0] === 0) {
        delete cart[pid];
      }
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    });

    $("#items").on("click", ".qty-plus", function () {
      const pid = $(this).data("id");
      if (!cart[pid]) return;
      cart[pid][0] = cart[pid][0] + 1;
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    });

    renderCart();

    {% if thank %}
    alert("Thanks for ordering with us. Your order id is {{id}}. Use it to track your order using our order tracker")
    localStorage.clear();
    document.location="";
    {%endif%}
</script>

{% endblock %}
