{% extends 'shopping/basic.html' %}
{% block title%}Seasonal AI Assistant{% endblock %}
{% block css %}
body {
  background: radial-gradient(circle at 20% 20%, #f6f8ff, #eef4ff 45%, #e0ecff);
}
.chat-wrapper {
  max-width: 920px;
}
.chat-card {
  background: #0d1b2a;
  color: #e7f1ff;
  border-radius: 18px;
  box-shadow: 0 18px 40px rgba(13, 27, 42, 0.25);
}
.chat-header {
  background: linear-gradient(135deg, #0b132b, #1c2541);
  border-radius: 18px 18px 0 0;
}
.chat-log {
  height: 460px;
  overflow-y: auto;
  padding: 18px;
  scrollbar-width: thin;
}
.bubble {
  max-width: 80%;
  border-radius: 14px;
  padding: 12px 14px;
  margin-bottom: 12px;
}
.bot-msg .bubble {
  background: #13315c;
  color: #e7f1ff;
}
.user-msg {
  display: flex;
  justify-content: flex-end;
}
.user-msg .bubble {
  background: #22d1ee;
  color: #04101f;
  font-weight: 600;
}
.product-pill {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
}
.product-pill a {
  color: #9ae6ff;
  text-decoration: underline;
}
.input-row {
  border-top: 1px solid rgba(255, 255, 255, 0.08);
}
{% endblock %}
{% block body %}
<div class="container py-5 chat-wrapper">
  <div class="card chat-card">
    <div class="card-header chat-header">
      <div class="h5 mb-0 text-white">AI Deals Assistant</div>
      <small class="text-light">Ask for gift ideas or seasonal deals.</small>
    </div>
    <div class="chat-log" id="chatLog">
      <div class="bot-msg">
        <div class="bubble">
          Hi! I am your shopping assistant! Please tell me what you are looking for or your mood today!
        </div>
      </div>
    </div>
    <div class="p-3 input-row">
      <div class="input-group">
        <input
          type="text"
          id="messageInput"
          class="form-control"
          placeholder="Example: Looking for cozy Christmas gifts under $50"
          aria-label="Chat message"
        />
        <div class="input-group-append">
          <button class="btn btn-info" type="button" id="sendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block js %}
<script>
  const chatLog = document.getElementById("chatLog");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const csrftoken = getCookie("csrftoken");

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function appendMessage(sender, text) {
    const msgRow = document.createElement("div");
    msgRow.className = sender === "user" ? "user-msg" : "bot-msg";
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    msgRow.appendChild(bubble);
    chatLog.appendChild(msgRow);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function appendProducts(items) {
    if (!items || !items.length) return;
    items.forEach((item) => {
      const wrapper = document.createElement("div");
      wrapper.className = "product-pill";
      wrapper.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>${item.name}</strong>
            <div class="small text-light">${item.category}</div>
            <div class="small text-light">$${item.price}</div>
          </div>
          <a href="/shopping/products/${item.id}" class="small">View</a>
        </div>
        <div class="small text-light mt-1">${item.desc.slice(0, 90)}...</div>
      `;
      chatLog.appendChild(wrapper);
    });
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    appendMessage("user", message);
    messageInput.value = "";
    appendMessage("bot", "Thinking about seasonal matches...");
    try {
      const response = await fetch("/shopping/recommend/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({ message }),
      });
      if (!response.ok) throw new Error("Network error");
      const data = await response.json();
      // Replace loading text with real reply
      const lastBubble = chatLog.querySelector(".bot-msg:last-child .bubble");
      if (lastBubble && lastBubble.textContent.includes("Thinking")) {
        lastBubble.textContent = data.reply;
      } else {
        appendMessage("bot", data.reply);
      }
      appendProducts(data.items);
    } catch (err) {
      appendMessage("bot", "I hit a snag fetching recommendations. Please try again.");
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  messageInput.addEventListener("keyup", (e) => {
    if (e.key === "Enter") sendMessage();
  });
</script>
{% endblock %}
